//>>built
define("epi/shell/ContextService",["dojo","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/promise/all","dojo/topic","dojox/html/entities","dijit/Destroyable","epi","epi/dependency","epi/shell/DialogService","epi/UriParser","epi/i18n!epi/shell/ui/nls/EPiServer.Shell.UI.Resources.ContextService"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e){return _3([_9],{currentContext:null,_contextStore:null,_profile:null,_routes:{},res:_e,_requestQueue:null,_requestInterceptors:null,_dialogService:null,constructor:function(_f,_10,_11){this._contextStore=_f;if(_10===undefined){this._profile=_b.resolve("epi.shell.Profile");}this._requestInterceptors=[];this._requestQueue=[];this._dialogService=_11||_c;this._initialize();},_initialize:function(){this.own(_7.subscribe("/epi/shell/context/request",_4.hitch(this,this._handleContextChangeRequest)),_7.subscribe("/epi/shell/context/updateRequest",_4.hitch(this,this._handleContextUpdateRequest)),_7.subscribe("/epi/shell/context/requestcurrent",_4.hitch(this,this._handleRequestCurrentContext)));},registerRoute:function(_12,_13){this._routes[_12]=_13;},registerRequestInterceptor:function(_14){var _15=_2.indexOf(this._requestInterceptors,_14);if(_15===-1){this._requestInterceptors.push(_14);}return {remove:_4.hitch(this,function(){this.unregisterRequestInterceptor(_14);})};},unregisterRequestInterceptor:function(_16){var _17=_2.indexOf(this._requestInterceptors,_16);if(_17!==-1){this._requestInterceptors.splice(_17,1);return _16;}return null;},query:function(_18){return this._executeInterceptors(_18,{}).then(_4.hitch(this,function(){return this._getContextStore().query(_18);}));},_handleContextChangeRequest:function(_19,_1a){if(_19===null){this.currentContext={};this._publishContextChanged(this.currentContext);return;}this._executeInterceptors(_19,_1a).then(_4.hitch(this,function(){this._loadNewContext(_19,_1a,this._publishContextChanged);})).otherwise(_4.hitch(this,function(){this._publishRequestFailed(_19,_1a);}));},_executeInterceptors:function(_1b,_1c){var _1d=_2.map(this._requestInterceptors,function(_1e){return _1e(_1b,_1c);});return _6(_1d);},_handleContextUpdateRequest:function(_1f,_20){if(_1f===null){return;}this._loadNewContext(_1f,_20,this._publishContextUpdated);},_handleRequestCurrentContext:function(_21){if(this.currentContext){_7.publish("/epi/shell/context/current",this.currentContext,_21);}},_loadNewContext:function(_22,_23,_24){var _25={success:null,request:null,response:null,contextParameters:_22,callerData:_23,callback:_24};var _26=_4.hitch(this,function(_27){_25.response=_27;_25.success=false;this._handleContextLoaded();});var _28=_4.hitch(this,function(_29){if(_29){_25.response=_29;_25.success=true;this._handleContextLoaded();}else{_26(_29);}});this._requestQueue.push(_25);var _2a=this._getContextStore();var rq=_2a.query(_22);rq.then(_28,_26);_25.request=rq;},_handleContextLoaded:function(){var _2b=(this._requestQueue.length>0)?this._requestQueue[0]:null;while(_2b&&_2b.success!==null){this._requestQueue.shift();var _2c=_2b.callback;var _2d=_2b.response;var _2e=_2b.contextParameters;var _2f=_2b.callerData;var _30=_2b.success;var _31=_2b.request;if(_30){var uri=new _d(_2d.uri);_2d.type=uri.getType();_2d.id=uri.getId();this.currentContext=_2b.response;if(this._routes&&this._routes[_2d.type]){this._routes[_2d.type](this.currentContext,_2f,uri);}if(_2c){_2c(_2d,_2f,_31);}}else{if(_2f&&!_2f.suppressFailure){this._contextLoadFailed(_2d,_2e,_2f);}else{this._publishRequestFailed(_2e,_2f);}}_2b=(this._requestQueue.length>0)?this._requestQueue[0]:null;}},_contextLoadFailed:function(_32,_33,_34){var _35=this.res.errors.couldnotloadcontext.description,_36=this.res.errors.couldnotloadcontext["descriptioncontent"+_32.status],_37=this.res.errors.couldnotloadcontext["description"+_32.status];if(_36&&_34.sender&&_34.sender.requestedContent){var _38=_34.sender.requestedContent;_35=_4.replace(_36,[_8.encode(_38.typeName),_8.encode(_38.name)]);}else{if(_37){_35=_4.replace(_37,[_33.uri||_33.url]);}}this._dialogService.confirmation({title:this.res.errors.couldnotloadcontext.title,description:_35,confirmActionText:this.res.errors.couldnotloadcontext.retry,cancelActionText:_a.resources.action.ignore}).then(function(){this._loadNewContext(_33,_34,this._publishContextChanged);}.bind(this)).otherwise(function(){this._publishRequestFailed(_33,_34);}.bind(this));},_getContextStore:function(){if(!this._contextStore){var _39=_b.resolve("epi.storeregistry");this._contextStore=_39.get("epi.shell.context");}return this._contextStore;},_publishContextChanged:function(_3a,_3b,_3c){_7.publish("/epi/shell/context/changed",_3a,_3b,_3c);},_publishContextUpdated:function(_3d,_3e,_3f){_7.publish("/epi/shell/context/updated",_3d,_3e,_3f);},_publishRequestFailed:function(_40,_41){_7.publish("/epi/shell/context/requestfailed",this.currentContext,_40,_41);}});});