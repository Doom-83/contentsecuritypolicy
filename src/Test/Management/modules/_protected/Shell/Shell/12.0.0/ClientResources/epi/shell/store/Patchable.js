//>>built
define("epi/shell/store/Patchable",["dojo/_base/lang","dojo/aspect","dojo/Deferred","dojo/promise/all","dojo/store/Cache","dojo/store/Observable","dojo/when","epi/shell/store/storeDelegate"],function(_1,_2,_3,_4,_5,_6,_7,_8){return function(_9,_a,_b){var _c=_5(_9,_a,_b||{}),_d=[];var _e=function(_f,_10){if(typeof _f!==typeof _10){console.error("The store was queried with a ["+typeof _f+"] but the entity id is a ["+typeof _10+"]");}};var _11=function(_12,_13){if(typeof _13=="object"){_12[_14.idProperty]=_13[_14.idProperty];}else{_12[_14.idProperty]=_13;}};var _15=function(_16){if(_16._cached){_16._cached=new Date();}else{Object.defineProperty(_16,"_cached",{value:new Date(),enumerable:false});}return _16;};var _17=function(_18){if(!_18._cached){return false;}var now=new Date();now.setMinutes(now.getMinutes()-5);return now>_18._cached;};_c.get=function(id,_19){return _7(_a.get(id),function(_1a){if(_1a){if(_17(_1a)){_c.evict(id,_19);_1a=null;}}return _1a||_7(_9.get(id,_19),function(_1b){if(_1b){_e(id,_1b[_9.idProperty]);_a.put(_15(_1b),{id:id});}return _1b;});});};_c.put=function(_1c,_1d){_a.remove((_1d&&_1d.id)||this.getIdentity(_1c));return _7(_9.put(_1c,_1d),function(_1e){_11(_1c,_1e);_a.put(typeof _1e=="object"?_15(_1e):_15(_1c),_1d);return _1e;});};_c.add=function(_1f,_20){return _7(_9.add(_1f,_20),function(_21){_11(_1f,_21);_a.add(typeof _21=="object"?_15(_21):_15(_1f),_20);return _21;});};var _22=function(obj){return obj&&_1.isObject(obj)&&!_1.isArray(obj)&&!_1.isFunction(obj);};var _23=function(_24,_25){var _26,s,_27={};for(_26 in _25){s=_25[_26];if(_26 in _24&&(_24[_26]!==s&&(!(_26 in _27)||_27[_26]!==s))){if(_22(s)&&_22(_24[_26])){_23(_24[_26],s);}else{_24[_26]=s;}}}return _24;};var _28=_6(_c);var _14=_8(_28,{getCached:function(id){return _a.get(id);},refresh:function(id,_29){return _7(this.evict(id),_1.hitch(this,function(){return _7(this.get(id),_1.hitch(this,function(_2a){if(_2a){!_29&&this.notify(_2a,id);this.updateDependentStores(_2a);!_29&&this.onItemChanged(id,_2a);}return _2a;}));}));},removeRange:function(ids){var _2b=this;var _2c=ids.map(function(id){_2b.evict(id);});var _2d=_4(_2c).then(function(){return _7(_2b.executeMethod("DeleteRange","",ids));});_2d.then(function(){ids.forEach(function(id){_2b.notify(undefined,id);});});return _2d;},patchCache:function(_2e){if(!_2e){return;}var id=this.getIdentity(_2e);return _7(this.get(id),_1.hitch(this,function(_2f){if(_2f){_2f=_23(_2f,_2e);_7(_a.put(_2f,{overwrite:true}),_1.hitch(this,function(){this.notify(_2f,id);this.updateDependentStores(_2e);this.onItemChanged(id,_2f);}));}return _2f;}));},addDependentStore:function(_30,_31){if(!_30.patchCache){throw new Error("addDependentStore: The store must implement the patch method.");}_d.push({store:_30,options:_31||{}});},updateDependentStores:function(_32){for(var i=_d.length-1;i>=0;i--){var _33=_d[i].store;if(_d[i].options.refreshOnPatch){var _34=_d[i].options.refresh;if(typeof _34==="function"){_34(_32);}else{_33.refresh(this.getIdentity(_32));}}else{var _35=_d[i].options.transformDelegate;_33.patchCache(typeof _35==="function"?_35(_32):_32);}}},onItemChanged:function(id,_36){}});return _14;};});