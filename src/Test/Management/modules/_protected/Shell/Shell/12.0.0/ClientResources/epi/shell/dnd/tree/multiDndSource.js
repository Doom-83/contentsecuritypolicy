//>>built
define("epi/shell/dnd/tree/multiDndSource",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/aspect","dojo/dom-class","dojo/dom-geometry","dojo/_base/lang","dojo/on","dojo/touch","dojo/topic","dojo/dnd/Manager","dojo/when","dijit/tree/dndSource","../_DndDataMixin","epi/shell/TypeDescriptorManager"],function(_1,_2,_3,_4,_5,_6,_7,on,_8,_9,_a,_b,_c,_d,_e){return _3([_c,_d],{generateText:false,singular:false,constructor:function(){var _f=this.reject;if(_f){var _10=[];for(var key in this.accept){_10.push(key);}this.accept={};_10=_e.removeIntersectingTypes(_10,this.reject);_1.forEach(_10,function(_11){this.accept[_11]=1;},this);for(var i=0;i<_f.length;++i){this.accept[_f[i]]=0;}}var _12=_a.manager();this._startDragHandle=_4.before(_12,"startDrag",this._beforeStartDrag.bind(this));},destroy:function(){this.inherited(arguments);this._startDragHandle.remove();delete this._startDragHandle;},_beforeStartDrag:function(_13,_14,_15){if(_13!==this){return arguments;}var _16=this.getSelectedTreeNodes();if(!_16.length){return arguments;}_16=_16.map(function(_17){return _17.domNode;});return [_13,_16,_15];},deleteSelectedNodes:function(){},onDndDrop:function(_18,_19,_1a,_1b){if(this.containerState==="Over"){var _1c=this.tree,_1d=_1c.model,_1e=this.targetAnchor;this.isDragging=false;var _1f;var _20=(_1e&&_1e.item)||_1c.item;if(this.dropPosition==="Before"||this.dropPosition==="After"){_20=(_1e.getParent()&&_1e.getParent().item)||_1c.item;_1f=_1e.getIndexInParent();if(this.dropPosition==="After"){_1f=_1e.getIndexInParent()+1;}}var _21=this.itemCreator(_19,_1e.rowNode,_18,_1b);if(_18===this){if(_1d.pasteItems){var _22=_21.map(function(_23){if(_23.dndData){return _23.dndData.data;}return _23;});_1d.pasteItems(_22,_20,_1a,_1f);}else{_1.forEach(_21,function(_24){if(_24.dndData){var _25=_24.dndData.options;var _26=_25?_25.oldParentItem:null;var _27=_25?_25.indexInParent:0;if(typeof _1f=="number"){if(_20===_26&&_27<_1f){_1f-=1;}}_1d.pasteItem(_24.dndData.data,_26,_20,_1a,_1f);}});}}else{if(_1d.newItems){_1d.newItems(_21,_20,_1f);}else{_1.forEach(_21,function(_28){_1d.newItem(_28,_20,_1f);});}}if(!_18.isDragging&&!_1b.isDragging){this.onDndEnd();}}if(this===_1b&&_18!==_1b&&!_1a&&_18.onDndItemRemoved){var _29=_1.map(_19,function(_2a){return this._getDndData(_18.getItem(_2a.id),this.accept,false);},this);_18.onDndItemRemoved(_29,_18,_19,_1a,_1b);}this.onDndCancel();},onMouseOut:function(){this.inherited(arguments);if(this._expandOnDndTimeout){clearTimeout(this._expandOnDndTimeout);}},_onDragMouse:function(e,_2b){this.inherited(arguments);var m=_a.manager();if(m.canDropFlag){_b(this.checkItemAcceptance(this.current.rowNode,m.source,this.dropPosition.toLowerCase()),function(_2c){m.canDrop(_2c);});}if(this._expandOnDndTimeout){clearTimeout(this._expandOnDndTimeout);}if(this.tree&&this.tree.expandOnDnd===true&&this.targetAnchor){this._expandOnDndTimeout=setTimeout(function(){this.isDragging&&this.tree._expandNode(this.targetAnchor);}.bind(this),500);}},onDndEnd:function(){},onDndItemRemoved:function(_2d,_2e,_2f,_30,_31){},itemCreator:function(_32,_33,_34,_35){return _1.map(_32,function(_36){return {id:_36.id,name:_36.textContent||_36.innerText||"",dndData:this._getDndData(_34.getItem(_36.id),this.accept,this===_34)};},this);},getItem:function(key){var _37=this.inherited(arguments);if(this.tree.getItemType&&_37&&_37.data&&_37.data.item){_37.type=this.tree.getItemType(_37.data.item);}_37.options=this.getItemOptions(_37);return _37;},getItemOptions:function(_38){var _39={};if(_38.data){if(_38.data.getParent){var _3a=_38.data.getParent();_39.oldParentItem=_3a?_3a.item:null;}if(_38.data.getIndexInParent){_39.indexInParent=_38.data.getIndexInParent();}}return _39;},onMouseDown:function(e){var _3b=_5.contains(e.target,"dojoDndContainerOver");var _3c=_5.contains(e.target,"dijitTreeContainer");if(_3b||_3c){return;}this.inherited(arguments);},onMouseUp:function(e){if(this.current){var id=this.current.id;if(!this.singular&&!e.shiftKey&&this.selection[id]&&_5.contains(e.target,"epi-iconContextMenu")){this._doDeselect=false;}}this.inherited(arguments);},checkAcceptance:function(_3d,_3e){if(this.readOnly){return false;}var _3f=_1.map(_3e,function(_40){return _3d.getItem(_40.id);});return this._checkAcceptanceForItems(_3f,this.accept);}});});