//>>built
define("epi/shell/SearchManager",["dojo/_base/declare","dojo/_base/array","dojo/_base/Deferred","dojo/_base/lang","dojo/when","dojo/promise/all","epi/dependency"],function(_1,_2,_3,_4,_5,_6,_7){return _1(null,{_providersStore:null,_resultsStore:null,constructor:function(_8){this._setupStores(_8||{});},getProviderQuery:function(_9){var _a=new _3();var _b=[];var _c=_9?_9.split(","):[];_c.forEach(function(a){_b.push(this._getFirstMatchingProvider(a));},this);_6(_b).then(function(_d){_d=_d.filter(function(p){return p;});if(_d.length>0){_a.resolve(this._getQuery(_d,{}));}else{_a.resolve();}}.bind(this));return _a;},_getFirstMatchingProvider:function(_e){var _f=new _3();_5(this.getProviders(_e)).then(function(_10){if(_10&&_10.length>0){_f.resolve(_10[0]);}else{_f.resolve();}});return _f.promise;},getProviders:function(_11){var _12=new _3();_5(this._providersStore.query({searchArea:_11})).then(function(_13){if(_13&&_13.length>0){_12.resolve(_13);}else{_12.resolve();}});return _12;},getStore:function(){return this._resultsStore;},search:function(_14,_15){var _16=new _3();_5(this.getProviders(_14)).then(_4.hitch(this,function(_17){if(_17&&_17.length>0){var _18=[];_2.forEach(_17,function(_19,_1a){_18.push(this._getData(_19,_15));},this);var _1b=[];_6(_18).then(function(_1c){_1c.forEach(function(_1d){if(_4.isArray(_1d)){_1b=_1b.concat(_1d);}});_16.resolve(_1b);});}}));return _16;},_setupStores:function(_1e){this._providersStore=_1e.providersStore||_7.resolve("epi.storeregistry").get("epi.shell.searchproviders");this._resultsStore=_1e.resultsStore||_7.resolve("epi.storeregistry").get("epi.shell.searchresults");},_getQuery:function(_1f,_20){var _21;if(_4.isArray(_1f)){_21=_1f.map(function(p){return p.id;}).join(",");}else{_21=_1f.id;}var _22={providerId:_21};_4.mixin(_22,_20||{});return _22;},_getData:function(_23,_24){var _25=new _3();_5(this._resultsStore.query(this._getQuery(_23,_24))).then(function(_26){if(_26&&_26.length>0){_25.resolve(_26);}else{_25.resolve();}});return _25.promise;}});});