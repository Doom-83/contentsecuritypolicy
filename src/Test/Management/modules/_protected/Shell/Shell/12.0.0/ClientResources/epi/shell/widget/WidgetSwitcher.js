//>>built
define("epi/shell/widget/WidgetSwitcher",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/topic","dojo/when","epi/shell/StickyViewSelector","epi/shell/_ContextMixin","epi/shell/layout/AnimatedCardContainer","epi/shell/TypeDescriptorManager"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _2([_9,_8],{componentConstructorArgs:null,supportedContextTypes:null,_stickyViewSelector:null,constructor:function(){this._viewHistory=[];},postMixInProperties:function(){this.inherited(arguments);this._stickyViewSelector=new _7();if(this.supportedContextTypes){if(!_3.isArray(this.supportedContextTypes)){this.supportedContextTypes=[this.supportedContextTypes];}if(!_1.every(this.supportedContextTypes,function(_b){return typeof _b=="string";})){throw new Error("supportedContextTypes must be string, array of strings or null.");}}},postCreate:function(){this.inherited(arguments);_6(this.getCurrentContext(),_3.hitch(this,this.contextChanged));this.own(_5.subscribe("/epi/shell/action/changeview",_3.hitch(this,"viewComponentChangeRequested")),_5.subscribe("/epi/shell/action/changeview/back",_3.hitch(this,"_viewComponentBackRequested")),_5.subscribe("/epi/shell/action/changeview/updatestate",_3.hitch(this,"_changeViewState")));},contextChanged:function(_c,_d){if(!this._isContextTypeSupported(_c)){return;}var _e=_c.customViewType||(_d?_d.viewType:null);var _f=this._getCurrentWidgetInfo();if(_d&&_d.contextIdSyncChange&&_f){_e=_f.type;_d=_3.mixin({},_d,{viewName:_f.viewName,availableViews:_f.availableViews});}if(!_e&&_c.dataType){_e=_a.getValue(_c.dataType,"mainWidgetType");}if(_e){this._getObject(_e,null,_c,_d);}else{var _10=_a.getValue(_c.dataType,"defaultView"),_11=this._getAvailableViews(_c.dataType),_12=_d?_d.viewName:null;_6(this._stickyViewSelector.get(_c.hasTemplate,_c.dataType)).then(function(_13){if(_13){_10=_13;}var _14=["view","sidebysidecompare","allpropertiescompare"];if(_f&&_14.indexOf(_f.viewName)>=0){_1.some(_11,function(_15){if(_15.key===_f.viewName){_10=_f.viewName;return true;}return false;});}var _16=this._getViewByKey(_12||_10,_11);if(!_16){return;}this._loadViewComponentByConfiguration(_16,_11,null,_c,_d);}.bind(this));}},_getViewByKey:function(key,_17){return _1.filter(_17,function(_18){return _18.key===key;})[0];},_getAvailableViews:function(_19){var _1a=_a.getAndConcatenateValues(_19,"availableViews"),_1b=_a.getValue(_19,"disabledViews");var _1c=_1.filter(_1a,function(_1d){return _1.every(_1b,function(_1e){return _1d.key!==_1e;});});return _1c.sort(function(x,y){return x.sortOrder<y.sortOrder?-1:1;});},_loadViewComponentByConfiguration:function(_1f,_20,_21,_22,_23,_24){_23=_3.mixin({},_23,{viewName:_1f.key,availableViews:_20});this._getObject(_1f.controllerType,_21,_22,_23,_24);},viewComponentChangeRequested:function(_25,_26,_27,_28){_6(this.getCurrentContext(),_3.hitch(this,function(_29){var _2a=_29?_29.dataType:null;var _2b=_29?_29.hasTemplate:false;var _2c=this._getAvailableViews(_2a);var _2d;var _2e;if(!_25&&_2a){_2d=_a.getValue(_2a,"defaultView");_2e=this._stickyViewSelector.get(_2b,_2a);if(_2e){_25=_2e;}else{_25=_2d;}}_6(_25).then(function(_2f){var _30=this._getViewByKey(_2f||_2d,_2c);if(_30){this._loadViewComponentByConfiguration(_30,_2c,_26,_29,_27,_28);}else{this._getObject(_2f,_26,_29,_27,_28);}}.bind(this));}));},_viewComponentBackRequested:function(_31){var _32=this._getPreviousWidgetInfo();if(_32){if(typeof _31==="undefined"){_31=false;}var _33={skipUpdateView:!_31,availableViews:_32.availableViews,viewName:_32.viewName};_6(this.getCurrentContext(),_3.hitch(this,function(_34){this._getObject(_32.type,null,_34,_33);}));}},_changeViewState:function(_35){var _36=this._getCurrentWidgetInfo();if(_36){_3.mixin(_36,_35);}},_getPreviousWidgetInfo:function(){var _37=this._viewHistory.length;var _38=this._viewHistory;var _39=(_38.length>1)?_38[_38.length-2]:null;this._viewHistory.splice(_37-1,1);return _39;},_getCurrentWidgetInfo:function(){var _3a=this._viewHistory;return (_3a.length>0)?_3a[_3a.length-1]:null;},_isContextTypeSupported:function(_3b){if(!_3b){return false;}if(!this.supportedContextTypes){return true;}return _1.some(this.supportedContextTypes,function(_3c){return _3b.type===_3c;});},_getObject:function(_3d,_3e,_3f,_40,_41){if(!_3d){return;}var _42=this.selectedChildWidget;var _43=_3.hitch(this,function(){_6(this._testComponentInstanceOf(_42,_3d),_3.hitch(this,function(_44){if(_41){this._stickyViewSelector.save(_3f.hasTemplate,_3f.dataType,_40.viewName);}if(_44){this._updateHistory(_3d,_40,_3f);this._updateView(_42,_3f,_40);this._onViewChanged(_3d,_3e,_40);}else{this._changeViewComponent(_3d,_3e,_3f,_40);}}));});if(_42&&_42.savePendingChanges){_6(_42.savePendingChanges(),_43);}else{_43();}},_changeViewComponent:function(_45,_46,_47,_48){_6(this._getChildByType(_45),_3.hitch(this,function(_49){var _4a=this.selectedChildWidget;if(_4a){_4a.set("isActive",false);}if(_49){_49.set("isActive",true);if(_48&&_48.treatAsSecondaryView){this.selectSecondaryChild(_49);}else{this.selectChild(_49);}this._updateHistory(_45,_48,_47);this._updateView(_49,_47,_48,true);this._onViewChanged(_45,_46,_48);}else{require([_45],_3.hitch(this,function(_4b){var _4c=_3.mixin(_3.mixin({},this.componentConstructorArgs,{componentTypeName:_45}),_46);_49=new _4b(_4c);_49.fitContainer=true;this.addChild(_49);var _4d;if(_48&&_48.treatAsSecondaryView){_4d=this.selectSecondaryChild(_49);}else{_4d=this.selectChild(_49);}_6(_4d,_3.hitch(this,function(){this._updateHistory(_45,_48,_47);this._updateView(_49,_47,_48,true);this._onViewChanged(_45,_46,_48);}));}));}}));},_updateView:function(_4e,_4f,_50,_51){if(_4e&&!_4e._started&&typeof _4e.startup==="function"){_4e.startup();}if(_4e&&typeof _4e.updateView==="function"){_4e.updateView(_50,_4f,{widgetResumed:_51});}},_getChildByType:function(_52){var def=new _4();require([_52],_3.hitch(this,function(_53){var _54=_1.filter(this.getChildren(),function(_55){return _55.constructor===_53;},this);def.resolve(_54.length?_54[0]:null);}));return def;},_testComponentInstanceOf:function(_56,_57){var def=new _4();if(_56){if(typeof _57==="string"){require([_57],function(_58){def.resolve(_56&&_56.constructor===_58);});}else{def.resolve(_56&&_56.constructor===_57.constructor);}}else{def.resolve(false);}return def;},_onViewChanged:function(_59,_5a,_5b){_5.publish("/epi/shell/action/viewchanged",_59,_5a,_5b);},_updateHistory:function(_5c,_5d,_5e){var _5f=this._viewHistory,_60=_5f.length,_61=this.createStoreItem(_5c,_5d,_5e);if(_60&&_5f[_60-1].id===_61.id){return;}if(_60===9){_5f.shift();}_5f.push(_61);},createStoreItem:function(_62,_63,_64){var _65={type:_62,id:_62};if(_63){var _66=_63.availableViews||(_64&&this._getAvailableViews(_64.dataType));var _67=_63.viewName||this._getViewName(_66,_64);_65=_3.mixin(_65,{availableViews:_66,viewName:_67});_65.id+="#"+_67;}return _65;},_getViewName:function(_68,_69){if(!_69){return null;}var _6a=this._getViewByKey(_a.getValue(_69.dataType,"defaultView"),_68);if(!_6a){return null;}return _6a.key;}});});