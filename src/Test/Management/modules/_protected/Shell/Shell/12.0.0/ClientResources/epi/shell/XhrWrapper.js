//>>built
define("epi/shell/XhrWrapper",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","epi/shell/applicationSettings","epi/shell/request/xhr","epi/shell/DialogService","epi/i18n!epi/nls/episerver.shared","epi/i18n!epi/shell/ui/nls/EPiServer.Shell.UI.Resources.reloaddialog"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){var _c;var _d=_3(null,{xhrHandler:null,_dialogService:null,_headerKeys:{loginScreen:"X-EPiLogOnScreen",postUrl:"X-EPiLogOnScreen-PostUrl",readOnlyMode:"X-EPiReadOnlyMode",readOnlyModeRedirectUrl:"X-EPiReadOnlyMode-RedirectUrl"},constructor:function(_e){_3.safeMixin(this,_e);this.xhrHandler=this.xhrHandler||_8;this._dialogService=this._dialogService||_9;},_readValidationToken:function(){if(_d.sharedXsrfHeader){return _d.sharedXsrfHeader;}_d.sharedXsrfHeader=document.getElementsByName(_7.antiforgeryTokenFieldName)[0].value;return _d.sharedXsrfHeader;},xhr:function(_f,_10){_10.headers=_10.headers||{};_10.headers[_7.antiforgeryTokenHeaderName]=this._readValidationToken();var _11=_4.delegate({method:_f,data:_10.content||_10.postData},_10);var _12=this.xhrHandler(_11.url,_11,true);var _13=new _5();_13.ioArgs=_12.ioArgs;_6(_12,_4.hitch(this,function(_14){_13.ioArgs=_12.ioArgs;_13.resolve(_14);}),_4.hitch(this,function(err){var _15=_12.ioArgs.xhr.getResponseHeader(this._headerKeys.loginScreen);if(_15==="true"||_12.ioArgs.xhr.status===401){this._showReloadDialog().then(_13.resolve);}else{if(_12.ioArgs.xhr.status===503){var _16=_12.ioArgs.xhr.getResponseHeader(this._headerKeys.readOnlyMode);var _17=_12.ioArgs.xhr.getResponseHeader(this._headerKeys.readOnlyModeRedirectUrl);if(_16&&_17){this._redirect(_17);}else{_13.reject(err);}}else{_13.reject(err);}}}));return _13;},xhrDelete:function(_18){return this.xhr("DELETE",_18);},xhrGet:function(_19){return this.xhr("GET",_19);},xhrPost:function(_1a){return this.xhr("POST",_1a,true);},xhrPut:function(_1b){return this.xhr("PUT",_1b,true);},_redirect:function(url){window.top.location=url;},_showReloadDialog:function(){if(this._isShowingReloadDialog()){return _c;}_c=this._dialogService.alert({acknowledgeActionText:_a.action.login,description:_b.loggedout,onAction:function(){_c=null;window.top.location.reload();}});return _c;},_isShowingReloadDialog:function(){return _c&&!_c.isResolved();}});_d.sharedXsrfHeader=undefined;return _d;});