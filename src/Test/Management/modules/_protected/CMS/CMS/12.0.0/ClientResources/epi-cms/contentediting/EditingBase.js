//>>built
define("epi-cms/contentediting/EditingBase",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/aspect","dojo/query","dojo/topic","dojo/when","epi/dependency","epi/string","epi/shell/DestroyableByKey","epi/shell/postMessage","epi-cms/ApplicationSettings","epi-cms/contentediting/MutationObserver","epi-cms/contentediting/_View","epi-cms/contentediting/AutoSaveButton","epi-cms/contentediting/MappingManager","epi-cms/contentediting/RenderManager","epi-cms/contentediting/UpdateController","epi-cms/widget/overlay/overlayFactory","epi/i18n!epi/cms/nls/episerver.cms.contentediting"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,res){return _3([_10,_c],{toolbar:null,editorFactory:null,activePropertyOnStartup:null,createOverlays:true,_renderManager:null,_mappingManager:null,_activeEditorWrapper:null,_autoSaveButton:null,_deferredReloadHandle:null,_eventHandlers:null,_isCreatingWrapper:null,_mutationObserver:null,constructor:function(){this.defaultQueryParameters={epieditmode:true};},postMixInProperties:function(){this.inherited(arguments);this.editorFactory=this.editorFactory||_a.resolve("epi.cms.contentediting.EditorFactory");this._mappingManager=new _12();this._mutationObserver=new _f();this.own(this._mutationObserver.on("dom-updated",function(){this.emit("dom-updated");}.bind(this)));this._eventHandlers=[];},postCreate:function(){this.inherited(arguments);this.subscribe("/epi/cms/action/disableundoredoactions",this._toggleUndoRedoActions);},destroy:function(){this._stopActiveEditorWrapper();if(this._renderManager){this._renderManager.destroy();}if(this._autoSaveButton){this._autoSaveButton.destroyRecursive();}this._mappingManager.clear();if(this.toolbar){this.toolbar=null;}this.overlay.destroyDescendants();this._mutationObserver.teardown();this.inherited(arguments);},_setCommandEnabled:function(_16,_17){if(this.toolbar){this.toolbar.setItemProperty(_16,"disabled",!_17);}},onContentLinkSyncChange:function(){this.inherited(arguments);this._setButtonState();},onReloadRequired:function(){this.inherited(arguments);setTimeout(function(){this._renderManager.suspend();this._renderManager.clear();}.bind(this),0);},_setViewModelAttr:function(_18){if(_18===this.viewModel){return;}this.inherited(arguments);this.destroyByKey("viewModel");this.ownByKey("viewModel",_2.connect(this.viewModel,"onContentChange",this,this._stopActiveEditorWrapper));this.ownByKey("viewModel",_2.connect(this.viewModel,"onSetActiveProperty",this,this.onSetActiveProperty));this.ownByKey("viewModel",_2.connect(this.viewModel,"onPropertyReverted",this,this._onPropertyReverted));this.ownByKey("viewModel",_8.subscribe("/dnd/start",function(){setTimeout(this.beginOperation.bind(this),0);}.bind(this.viewModel)));this.ownByKey("viewModel",_8.subscribe("/dnd/stop",_5.hitch(this,function(){if(this._activeEditorWrapper){return;}this.viewModel.endOperation();})));},_stopActiveEditorWrapper:function(){if(this._activeEditorWrapper!=null){_9(this._activeEditorWrapper.tryToStopEditing(),_5.hitch(this,function(){this._activeEditorWrapper=null;}));}},onSetActiveProperty:function(_19){},onPreviewReady:function(_1a,doc,_1b){if(_1b||_1a!==this.viewModel){this.set("viewModel",_1a);this.setupEditMode(doc);}else{if(_1a){this.remapEditMode(doc);}}},_setButtonState:function(){this._setCommandEnabled("reverttopublished",this.viewModel&&!this.viewModel.contentData.isPendingPublish);},setupEditMode:function(doc){this.viewModel.reload().then(_5.hitch(this,function(){this._mappingManager.clear();if(this._renderManager){this._renderManager.destroy();}this._renderManager=new _13();if(this.toolbar&&!this._autoSaveButton){this._autoSaveButton=new _11({button:this.toolbar._getWidget("autosave")});this.own(_6.after(this._autoSaveButton,"onLayoutChanged",_5.hitch(this,function(){this.mainLayoutContainer.layout();})));}this._autoSaveButton.set("model",this.viewModel);var _1c=_5.hitch(this,function(){this._toggleUndoRedoActions(this.viewModel.hasUndoSteps,this.viewModel.hasRedoSteps);});this.viewModel.resetNotifications();this._destroyOverlay();this.ownByKey("viewModel",this.viewModel.watch("hasUndoSteps",_1c),this.viewModel.watch("hasRedoSteps",_1c));_1c();this.onReadySetupEditMode(doc);if(_e.hasExternalTemplates){this.ownByKey("overlay",_d.subscribe(this.iFrame.name+"/site/property-positions",this._createOverlaysForProperties.bind(this)));_d.publish("/site/check-property-positions");}this._mutationObserver.setup(doc);doc=null;this._setButtonState();this.onPrepareOverlayComplete();}));},remapEditMode:function(doc){this.viewModel.reload().then(_5.hitch(this,function(){this._renderManager.resume();if(doc){setTimeout(_5.hitch(this,function(){this._remapUpdateControllers(doc);this.onPrepareOverlayComplete();this._toggleUndoRedoActions(this.viewModel.hasUndoSteps,this.viewModel.hasRedoSteps);this._autoSaveButton.set("model",this.viewModel);this._mutationObserver.setup(doc);}),1);}}));},_destroyOverlay:function(){this.destroyByKey("overlay");},onReadySetupEditMode:function(doc){this._createUpdateControllers(doc);},onSetupEditModeComplete:function(){if(this.activePropertyOnStartup){this.onSetActiveProperty(this.activePropertyOnStartup);this.activePropertyOnStartup=null;}},_getPropertyNodes:function(doc){var _1d=_7("[data-epi-edit], [data-epi-property-name]",doc);var _1e=_7("[data-epi-edit] [data-epi-edit], [data-epi-property-name] [data-epi-property-name], [data-epi-property-name] [data-epi-edit], [data-epi-edit] [data-epi-property-name]",doc);return _1.filter(_1d,function(_1f){return _1e.indexOf(_1f)===-1;});},_getOverlayParameters:function(_20,_21){var _22=[];_1.forEach(_20,function(_23){var _24=_23.dataset;var _25=_b.pascalToCamel(_24.epiEdit||_24.epiPropertyName);var _26=this.viewModel.getPropertyMetaData(_25);var _27=_21||!!_24.epiEdit;if(!_26){return;}if(_26.settings&&_26.settings.readOnly){return;}var _28=_b.pascalToCamel(_26.getName());var _29=_24.epiPropertyDisplayName;if(_29){_26=_5.delegate(_26,{displayName:_29});}if(_26!=null&&_26.showForEdit){var _2a={cacheResults:true,rerenderOnCancel:false,propertyRenderSettings:_24.epiPropertyRendersettings||undefined,useMvc:_24.epiUseMvc?_24.epiUseMvc.toLowerCase()==="true":false};_2a=_5.mixin(_2a,_26.additionalValues.renderSettings);var _2b=_27?"none":_24.epiPropertyRender||_26.customEditorSettings.rendererClass;switch(_2b){case "client":_2b="epi-cms/contentediting/ClientRenderer";break;case "none":_2b="epi-cms/contentediting/NullRenderer";break;}var _2c=JSON.parse(_24.epiPropertyEditorsettings||null);var _2d=JSON.parse(_24.epiPropertyOverlaysettings||null);_2d=_5.mixin(_2d,_26.overlaySettings);if(_27){_26.customEditorSettings.uiType=null;_26.customEditorSettings.uiWrapper=null;}_22.push({node:_23,disabled:_24.epiDisabled==="true",useOverlay:_24.epiUseoverlay==="true",overlayZIndex:parseInt(_24.epiOverlayZIndex,10)||0,property:{name:_28,contentLink:this.viewModel.contentLink,contentModel:this.viewModel.contentModel,type:_24.epiPropertyType,wrapperType:_27?"floating":_24.epiPropertyEdittype||null,editorParams:_2c,overlayParams:_2d,editorWidgetType:_24.epiPropertyEditor,renderSettings:_2a,rendererClass:_2b,metadata:_26,propertyNodeName:_25}});}},this);_22.sort(function(a,b){if(a.overlayZIndex<b.overlayZIndex){return -1;}else{if(a.overlayZIndex>b.overlayZIndex){return 1;}else{return 0;}}});return _22;},_getEditableNodes:function(doc){if(!doc||!this.viewModel.canChangeContent()){return [];}var _2e=this._getPropertyNodes(doc);return this._getOverlayParameters(_2e,false);},_createOverlaysForProperties:function(_2f){if(!this.overlay.enabled){return;}var _30=this._getOverlayParameters(_2f,true);var _31=this._mappingManager.find(function(_32){return !!_32.overlayItem;});this._mappingManager.clearMappings(_31);_30.forEach(function(_33){_15.createByDimensions(_33).then(function(_34){this.overlay.addChild(_34);this._connectUpdateControllerAndOverlayEvents(null,_34);this._mappingManager.add({blockPropertyInfo:_33.property,overlayItem:_34});}.bind(this));},this);},_createUpdateControllers:function(doc){var _35=this._createFullPageUpdateController(doc);if(_35){this._connectFullPageUpdateControllerEvents(_35);this._mappingManager.add({updateController:_35});}var _36=this._getEditableNodes(doc);_1.forEach(_36,function(_37){var _38=_37.property;var _39=_37.node.innerHTML;var _3a=this._createNodeUpdateController(_37);_9(this._createNodeOverlay(_37),_5.hitch(this,function(_3b){this._connectUpdateControllerAndOverlayEvents(_3a,_3b);this._mappingManager.add({blockPropertyInfo:_38,node:_37.node,updateController:_3a,overlayItem:_3b});}));this._renderManager.cacheRender(_38.name,_38.renderSettings,this.viewModel.getProperty(_38.name),_39);},this);},_createNodeOverlay:function(_3c){var _3d=new _4();if(!this.createOverlays){_3d.resolve(null);return _3d;}_9(_15.create(_3c),_5.hitch(this,function(_3e){this.overlay.addChild(_3e);_3d.resolve(_3e);}));return _3d;},_createNodeUpdateController:function(_3f){var _40=_3f.property;var _41=_40.metadata;var _42=new _14({displayName:_41.displayName,renderManager:this._renderManager,contentModel:_40.contentModel,contentLink:_40.contentLink,modelPropertyName:_40.name,nodePropertyName:_40.propertyNodeName,renderSettings:_40.renderSettings,rendererClass:_40.rendererClass,displayNode:_3f.node});return _42;},_createFullPageUpdateController:function(doc){var _43=[];if(doc){var _44=_7("input[data-epi-full-refresh-property-names][type='hidden']",doc);_1.forEach(_44,function(tag){_1.forEach(tag.dataset.epiFullRefreshPropertyNames.split(","),function(_45){if(!_1.some(_43,function(p){return p===_45;})){_43.push(_b.pascalToCamel(_45));}});});}_1.forEach(this.viewModel.metadata.properties,function(_46){if(_46.additionalValues["reloadOnChange"]===true){_43.push(_b.pascalToCamel(_46.name));}});if(!_43.length){return null;}var _47=new _14({displayName:"",renderManager:this._renderManager,contentModel:this.viewModel.contentModel,modelPropertyName:_43,renderSettings:{isFullReload:true}});return _47;},_remapUpdateControllers:function(doc){var _48=this._getEditableNodes(doc);var _49=this._mappingManager.remap(_48);_1.forEach(_49,function(_4a){var _4b=_4a.property;var _4c=this._createNodeUpdateController(_4a);_9(this._createNodeOverlay(_4a),_5.hitch(this,function(_4d){this._connectUpdateControllerAndOverlayEvents(_4c,_4d);this._mappingManager.add({blockPropertyInfo:_4b,node:_4a.node,updateController:_4c,overlayItem:_4d});}));this._renderManager.cacheRender(_4b.name,_4b.renderSettings,this.viewModel.getProperty(_4b.name),_4a.node.innerHTML);},this);var _4e=this._createFullPageUpdateController(doc);if(_4e){this._connectFullPageUpdateControllerEvents(_4e);this._mappingManager.add({updateController:_4e});}},_connectUpdateControllerAndOverlayEvents:function(_4f,_50){if(_4f){this.ownByKey("overlay",_6.after(_4f,"onReloadRequired",_5.hitch(this,this._onBlockReloadRequired),true),_6.after(_4f,"onRender",_5.hitch(this,this._onBlockRender),true));}if(_50){this.ownByKey("overlay",_6.after(_50,"onClick",_5.hitch(this,this._onOverlayItemClick),true),_6.after(_50,"onValueChange",_5.hitch(this,function(_51){this._onOverlayValueChange(_50,_51);}),true));}},_connectFullPageUpdateControllerEvents:function(_52){this.destroyByKey("fullpageoverlay");this.ownByKey("fullpageoverlay",_6.after(_52,"onReloadRequired",this._onBlockReloadRequired.bind(this),true),_6.after(_52,"onRender",this._onBlockRender.bind(this),true));},_getEditor:function(_53){var _54=this._mappingManager.findOne("overlayItem",_53);return (_54.wrapper&&_54.wrapper.editorWidget)?_54.wrapper.editorWidget:null;},onEditorWrapperCreated:function(_55){},_onOverlayItemClick:function(_56){if(this._isCreatingWrapper){return;}this._isCreatingWrapper=true;var _57=this._mappingManager.findOne("overlayItem",_56);var _58=_57.blockPropertyInfo;var val=this.viewModel.getProperty(_57.propertyName);var _59=_5.clone(val,true);var _5a;var _5b=_5.hitch(this,function(_5c){_57.wrapper=_5c;this._activeEditorWrapper=_5c;_8.publish("/epi/layout/pinnable/propertyEditor/show",null);_1.forEach(this._mappingManager.find(),function(m){if(m.overlayItem){m.overlayItem.set("active",false);}});_57.overlayItem.set("active",true);var _5d={value:_59,parent:_5c};_9(_5c.startEdit(_5d)).always(_5.hitch(this,function(){this._isCreatingWrapper=null;}));this.overlay.set("readOnly",_5c.isOverlayDisabled);this.viewModel.set("disableUndo",_5c.isUndoDisabled);});if(_57.wrapper){_5a=_57.wrapper;if(_5a&&_5a.editorWidget&&!_5a.editorWidget.overlayItem){_5a.editorWidget.overlayItem=_56;}_5a.set("blockDisplayNode",_57.node);_5b(_5a);}else{_9(this._createEditorWrapper(_58,_56,_57.node,_59),_5.hitch(this,function(_5e){_5b(_5e);this.onEditorWrapperCreated(_5e);}));}},_createEditorWrapper:function(_5f,_60,_61,_62){var def=new _4(),_63={overlayItem:_60};_9(this.editorFactory.createEditor(_5f,_61,_62,_63),_5.hitch(this,function(_64){this.ownByKey("overlay",_6.after(_64,"onValueChange",_5.hitch(this,this._onWrapperValueChange),true),_6.after(_64,"onCancel",_5.hitch(this,this._onWrapperCancel),true),_6.after(_64,"onStopEdit",_5.hitch(this,this._onWrapperStopEdit),true));def.resolve(_64);}),def.reject);return def;},_onBlockReloadRequired:function(_65){var _66=function(){if(this._activeEditorWrapper&&this._activeEditorWrapper.hasInlineEditor){return;}if(this._deferredReloadHandle){this._deferredReloadHandle.remove();this._deferredReloadHandle=null;}this._toggleUndoRedoActions(false,false);this.onReloadRequired();}.bind(this);if(this.viewModel.isSaved){_66();}else{if(!this._deferredReloadHandle){this.own(this._deferredReloadHandle=_6.after(this.viewModel,"onPropertySaved",_66,true));}}},_onBlockRender:function(_67){var _68=this._mappingManager.findOne("updateController",_67);if(_68&&_68.overlayItem){_68.overlayItem.refresh();}},_saveEditorChanges:function(_69,_6a){var _6b=this._getEditor(_69);if(_6b&&!_6b.overlayItem){_6b.overlayItem=_69;}if(_6b&&_6b.saveChanges){_6b.saveChanges(_6b,_6a);}},_onOverlayValueChange:function(_6c,_6d){this._saveEditorChanges(_6c,_6d.value);this.viewModel.setProperty(_6d.propertyName,_6d.value);},_onWrapperValueChange:function(_6e,_6f,_70){var _71=this._mappingManager.findOne("wrapper",_6e),_72=_71.propertyName;if(_71.overlayItem){_71.overlayItem.set("updated",true);}this.viewModel.beginOperation();this.viewModel.setProperty(_72,_6f,_70);},_onWrapperStopEdit:function(_73,_74,_75,_76){var _77=this._mappingManager.findOne("wrapper",_73);this.viewModel.endOperation();if(_77.overlayItem){_77.overlayItem.set("active",false);}this._activeEditorWrapper=null;this.overlay.set("readOnly",false);this.viewModel.set("disableUndo",false);},_onWrapperCancel:function(_78,_79){var _7a=this._mappingManager.findOne("wrapper",_78),_7b=_7a.updateController;this.viewModel.abortOperation();if(_7b&&_7b.renderSettings&&_7b.renderSettings.rerenderOnCancel){_7b.render();}if(_7a.overlayItem){_7a.overlayItem.set("active",false);}this._activeEditorWrapper=null;this.overlay.set("readOnly",false);this.viewModel.set("disableUndo",false);},_onPropertyReverted:function(_7c,_7d){this._mappingManager.find("propertyName",_7c).forEach(function(_7e){var _7f=_7e.wrapper,_80;if(_7f){_80=_7f.get("editing");_7f.set("editing",false);_7f.set("value",_7d);_7f.set("editing",_80);}});},_toggleUndoRedoActions:function(_81,_82){this._setCommandEnabled("undo",!!_81);this._setCommandEnabled("redo",!!_82);}});});