//>>built
require({cache:{"url:epi-cms/widget/templates/ThumbnailSelector.html":"<div data-dojo-attach-point=\"inputContainer, stateNode, dropAreaNode\" id=\"widget_${id}\"\r\n     class=\"dijitReset dijitInline dijitInputContainer epi-resourceInputContainer thumbnail-editor\">\r\n    <div class=\"dijitTextBox\" data-dojo-attach-point=\"_dropZone\" data-dojo-type=\"epi-cms/widget/FilesUploadDropZone\" data-dojo-attach-event=\"onDrop: _onDrop\" data-dojo-props=\"outsideDomNode: this.domNode\"></div>\r\n    <a class=\"thumbnail-button dijitTextBox\" href=\"#\" data-dojo-type=\"dijit/layout/_LayoutWidget\" data-dojo-attach-point=\"button\" data-dojo-attach-event=\"onClick: _onButtonClick\" >\r\n        <figure data-dojo-attach-point=\"displayNode\" class=\"dijitHidden\">\r\n            <img data-dojo-attach-point=\"thumbnail\"/>\r\n            <figcaption class=\"dijitInline dojoxEllipsis\">\r\n                <span data-dojo-attach-point=\"selectedContentNameNode\"></span>\r\n                <span data-dojo-attach-point=\"selectedContentLinkNode, resourceName\"></span>\r\n            </figcaption>\r\n        </figure>\r\n        <div data-dojo-type=\"dijit/ProgressBar\" data-dojo-attach-point=\"progressBar\" data-dojo-props=\"maximum:100\"></div>\r\n        <div data-dojo-attach-point=\"actionsContainer\" class=\"epi-content-area-actionscontainer\">\r\n            <span>${resources.selectimage}</span>\r\n        </div>\r\n    </a>\r\n\r\n    <a data-dojo-attach-point=\"clearButton\" href=\"#\" class=\"epi-clearButton\">&nbsp;</a>\r\n</div>\r\n"}});define("epi-cms/widget/ThumbnailSelector",["dojo/_base/declare","dojo/when","dojo/on","dojo/topic","dojo/dom-class","dijit/focus","dijit/ProgressBar","epi/Url","epi/routes","epi/shell/dnd/Target","epi/shell/DialogService","epi-cms/core/ContentReference","epi-cms/widget/MediaSelector","epi-cms/contentediting/_ContextualContentContextMixin","epi-cms/command/UploadContent","epi-cms/widget/UploadUtil","epi-cms/widget/viewmodel/MultipleFileUploadViewModel","epi-cms/widget/LocalFolderUploader","dojo/text!./templates/ThumbnailSelector.html","epi/i18n!epi/cms/nls/episerver.cms.widget.thumbnailselector","epi-cms/widget/FilesUploadDropZone"],function(_1,_2,on,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13){var _14=require.toUrl("epi-cms/themes/sleek/images/default-image.png");var _15=_1(_d,{_dialogService:null,allowedExtensions:[],postCreate:function(){this.inherited(arguments);this._dialogService=this._dialogService||_a;if(this._currentContext.currentMode==="create"){return;}this.uploadCommand=new _e({viewModel:this});_2(this.getCurrentContent()).then(function(_16){if(this._destroyed){return;}this._dropZone.set("settings",{enabled:true,validSelection:true,dropFolderName:this.getContextualRootName(_16),descriptionTemplate:_13.dropfile});}.bind(this));},_onButtonClick:function(){if(this.progressBar.progress&&this.progressBar.progress!==this.progressBar.maximum){return;}this.inherited(arguments);},upload:function(_17){var _18=new _11({model:new _10({store:this._store,query:this.query}),uploadProgressThreshold:40,thumbnailMaxFileSize:50*1024*1024});_18.own(on(_18,"uploadProgress",function(_19){if(this._destroyed){return;}this.progressBar.update({progress:_19});}.bind(this)));_18.own(on(_18,"uploadFilePreview",function(_1a,_1b){if(this._destroyed){return;}_4.add(this.domNode,"uploading");this.set("selectedContentName",_13.uploading+_1b);this.set("previewUrl",_1a);this.thumbnail.src=_1a;}.bind(this)));_18.own(_18.on("uploadComplete",function(_1c){if(this._destroyed){return;}this.progressBar.update({progress:0});_5.focus(this.button.domNode);_4.remove(this.domNode,"uploading");if(!_1c){this.set("value",this.value);this._dialogService.alert(_13.failed);return;}if(_1c.length===0){return;}if(_1c[0].statusMessage){this.set("value",this.value);this._dialogService.alert(_1c[0].statusMessage);return;}this.set("value",_1c[0].contentLink);this.onChange(this.value);_3.publish("/epi/cms/upload",this.assetsFolderLink);}.bind(this)));_18.upload(_17);},_refreshTargetUploadContent:function(){var _1d=this;if(this.assetsFolderLink&&!this.isPseudoContextualRoot({contentLink:this.assetsFolderLink})){return this.assetsFolderLink;}function _1e(_1f){if(!_1d.isPseudoContextualRoot({contentLink:_1f.assetsFolderLink})){return _1f.assetsFolderLink;}return _1d._store.refresh(_1f.contentLink).then(function(_20){return _20.assetsFolderLink;});};return _2(this.getCurrentContent()).then(function(_21){return _2(_1e(_21)).then(function(_22){_1d.assetsFolderLink=new _b(_22).createVersionUnspecificReference().toString();_1d.query.references=[_1d.assetsFolderLink];return _2(_1d._store.get(_22)).then(function(_23){_1d.uploadCommand.set("model",_23);});});});},_onDrop:function(evt,_24){_24=_f.filterFileOnly(_24);if(!_24||_24.length!==1){this._dialogService.alert(_13.singleimage);return;}var _25=_24[0].name.split(".").pop().toLowerCase();if(this.allowedExtensions.indexOf(_25)===-1){this._dialogService.alert(_13.wrongfileformat);return;}_2(this._refreshTargetUploadContent()).then(function(){this.uploadCommand.set("fileList",_24);this.uploadCommand.execute();}.bind(this));}});return _1([_c,_15],{resources:_13,templateString:_12,_setPreviewUrlAttr:function(_26){this.inherited(arguments);_4.toggle(this.displayNode,"dijitHidden",!_26);_4.toggle(this.actionsContainer,"dijitHidden",_26);},_getThumbnailUrl:function(_27){if(!_27.capabilities.generateThumbnail){return _27.thumbnailUrl||_14;}var url=new _7(_8.getActionPath({moduleArea:"CMS",controller:"Thumbnail",action:"Generate"}));url.query={contentLink:_27.contentLink,"epi.preventCache":new Date().valueOf()};return url.toString();},_updateDisplayNode:function(_28){this.inherited(arguments);if(_28){this.thumbnail.src=this._getThumbnailUrl(_28);}this.stateNode.title=_28?_28.name:"";},postCreate:function(){this.inherited(arguments);this.query={query:"getchildren",allLanguages:true};},_onButtonClick:function(){if(this.readOnly){return;}this.inherited(arguments);},_setReadOnlyAttr:function(_29){this.inherited(arguments);this.button.domNode.style.display="";this.button.set("readOnly",_29);}});});