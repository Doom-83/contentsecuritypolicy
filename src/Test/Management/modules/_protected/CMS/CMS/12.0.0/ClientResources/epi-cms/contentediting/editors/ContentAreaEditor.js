//>>built
require({cache:{"url:epi-cms/contentediting/editors/templates/ContentAreaEditor.html":"<div class=\"dijitInline\" tabindex=\"-1\" role=\"presentation\">\r\n    <div data-dojo-attach-point=\"treeNode\"></div>\r\n    <div data-dojo-attach-point=\"actionsContainer\" class=\"epi-content-area-actionscontainer\"></div>\r\n</div>\r\n"}});define("epi-cms/contentediting/editors/ContentAreaEditor",["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/dom-class","dojo/dom-style","dojo/on","dojo/topic","dojo/when","dijit/registry","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_CssStateMixin","dijit/_WidgetsInTemplateMixin","epi/shell/dnd/Target","epi/shell/command/_CommandProviderMixin","./_ContentAreaTree","./_ContentAreaTreeModel","./_TextWithActionLinksMixin","epi-cms/_ContentContextMixin","epi-cms/ApplicationSettings","epi-cms/contentediting/viewmodel/ContentAreaViewModel","epi/shell/widget/ContextMenu","epi/shell/widget/_ValueRequiredMixin","epi-cms/widget/overlay/Block","epi-cms/widget/command/CreateContentFromSelector","epi-cms/widget/_HasChildDialogMixin","epi-cms/contentediting/command/BlockRemove","epi-cms/contentediting/command/BlockEdit","epi-cms/contentediting/command/MoveToPrevious","epi-cms/contentediting/command/MoveToNext","epi-cms/contentediting/command/MoveOutsideGroup","epi-cms/contentediting/command/Personalize","epi-cms/contentediting/command/SelectDisplayOption","dojo/text!./templates/ContentAreaEditor.html","epi/i18n!epi/cms/nls/episerver.cms.contentediting.editors.contentarea"],function(_1,_2,_3,_4,_5,on,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c,_1d,_1e,_1f,_20,_21,_22){return _1([_9,_a,_c,_b,_16,_12,_e,_19,_11],{baseClass:"epi-content-area-editor",res:_22,templateString:_21,value:null,multiple:true,parent:null,overlayItem:null,model:null,intermediateChanges:true,editMode:"onpageedit",_preventOnBlur:false,_dndTarget:null,allowedTypes:null,restrictedTypes:null,constructor:function(){this.allowedDndTypes=[];},onChange:function(_23){},_handleModelChange:function(_24){this.validate();this.onChange(_24);},_onBlur:function(){if(this._preventOnBlur){return;}this.inherited(arguments);},focus:function(){if(this.tree&&this.model.get("value").length>0){this._focusManager.focus(this.tree.domNode);}else{if(this.textWithLinks){this.textWithLinks.focus();}}},postMixInProperties:function(){this.inherited(arguments);this.commands=this._commands||[new _1b(),new _20(),new _1c(),new _1d(),new _1a()];if(!_13.limitUI){this.commands.splice(2,0,new _1f({category:null}),new _1e());}this.commands.forEach(function(_25){this.own(_25);},this);this.own(this.model=this.model||new _14(),this.treeModel=this.treeModel||new _10({model:this.model}),this.model.watch("selectedItem",_2.hitch(this,function(_26,_27,_28){this.updateCommandModel(_28);})),on(this.model,"changed",_2.hitch(this,function(){if(!this._started||this._supressValueChanged){return;}this._set("value",this.model.get("value"));this._handleModelChange(this.value);})));this.allowedDndTypes.push("personalizationarea");},buildRendering:function(){this.inherited(arguments);this.contextMenu=new _15();this.contextMenu.addProvider(this);this.own(this.contextMenu);this.setupActionLinks(this.actionsContainer);this.own(this._dndTarget=new _d(this.actionsContainer,{accept:this.allowedDndTypes,reject:this.restrictedDndTypes,isSource:false,alwaysCopy:false,allowMultipleItems:true,insertNodes:function(){}}));this.own(_3.after(this._dndTarget,"onDropData",_2.hitch(this,function(_29,_2a,_2b,_2c){_29.forEach(function(_2d){this.model.modify(_2.hitch(this,function(){this.model.addChild(_2d.data);}));},this);if(!this.tree){this._createTree();}}),true));this.own(_3.after(this._dndTarget,"onDrop",_2.hitch(this,"focus")));},postCreate:function(){this.inherited(arguments);this.set("emptyMessage",_22.emptymessage);if(this.parent&&this.overlayItem){this.connect(this.parent,"onStartEdit",function(){this._selectFromOverlay(this.overlayItem.model);});}this.own(_6.subscribe("/dnd/start",_2.hitch(this,this._startDrag)));},startup:function(){if(this._started){return;}this.inherited(arguments);this.tree&&this.tree.startup();this.contextMenu.startup();},destroy:function(){this.tree&&this.tree.destroyRecursive();this.inherited(arguments);},isCreateLinkVisible:function(){return this.model.canCreateBlock(this.allowedTypes,this.restrictedTypes);},executeAction:function(_2e){if(_2e==="createnewblock"){this._preventOnBlur=true;this.validate(false);var _2f=new _18({creatingTypeIdentifier:"episerver.core.blockdata",createAsLocalAsset:true,autoPublish:true,allowedTypes:this.allowedTypes,restrictedTypes:this.restrictedTypes});_2f.set("model",{save:_2.hitch(this,function(_30){this._preventOnBlur=false;var _31=_2.clone(this.get("value"),true)||[];_31.push(_30);this.set("value",_31);this.parent.set("editing",true);this.onChange(_31);this.onBlur();}),cancel:_2.hitch(this,function(){this._preventOnBlur=false;this.onBlur();})});_2f.execute();}},isValid:function(_32){return (this._preventOnBlur||!this.required||this.model.get("value").length>0);},_setReadOnlyAttr:function(_33){this._set("readOnly",_33);_5.set(this.actionsContainer,"display",_33?"none":"");if(this._source){this._source.isSource=!this.readOnly;}if(this.model){this.model.set("readOnly",_33);}this.tree&&this.tree.set("readOnly",_33);},_checkAcceptance:function(_34,_35){return this.readOnly?false:this._source.defaultCheckAcceptance(_34,_35);},_createTree:function(){this.tree=new _f({accept:this.allowedDndTypes,reject:this.restrictedDndTypes,contextMenu:this.contextMenu,model:this.treeModel,readOnly:this.readOnly}).placeAt(this.domNode,"first");this.tree.own(_3.after(this.tree.dndController,"onDndEnd",_2.hitch(this,"focus")));},_selectFromOverlay:function(_36){var _37=_36&&_36.selectedItem&&_36.selectedItem.serialize(),_38=this.model,_39=["root"];if(!_37){return;}if(_37.contentGroup){_38=_38.getChild({name:_37.contentGroup});_39.push(_38.id);}_38=_38.getChild(_37);if(!_38){return;}_39.push(_38.id);_38.set("selected",true);_38.set("ensurePersonalization",_36.selectedItem.ensurePersonalization);this.tree&&this.tree.set("path",_39);},_startDrag:function(_3a,_3b,_3c){var _3d=this._dndTarget.accept&&this._dndTarget.checkAcceptance(_3a,_3b);_4.toggle(this.domNode,"dojoDndTargetDisabled",!_3d);var _3e=_8.getEnclosingWidget(_3b[0]);if(_3e&&_3e.isInstanceOf(_17)&&this.parent.cancel){this.parent.set("isModified",false);this.parent.cancel();}},_setValueAttr:function(_3f){this.tree&&this.tree.destroyRecursive();this._set("value",_3f||[]);this._supressValueChanged=true;this.model.set("value",_3f);this._supressValueChanged=false;this._createTree();}});});