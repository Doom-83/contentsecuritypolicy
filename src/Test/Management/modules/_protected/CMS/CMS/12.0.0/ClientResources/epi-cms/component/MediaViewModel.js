//>>built
define("epi-cms/component/MediaViewModel",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/when","dojo/topic","epi","epi/shell/widget/dialog/Dialog","epi-cms/core/ContentReference","epi-cms/asset/view-model/HierarchicalListViewModel","epi-cms/widget/viewmodel/MultipleFileUploadViewModel","epi-cms/widget/MultipleFileUpload","epi-cms/command/UploadContent","epi-cms/command/DownloadMedia","epi-cms/asset/command/UploadContentToSelection","epi/i18n!epi/cms/nls/episerver.cms.components.media"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10){return _2([_a],{dropZoneSettings:null,_dialog:null,postscript:function(){this.inherited(arguments);this.own(_6.subscribe("/epi/cms/upload",function(_11){this.set("selectedTreeItems",this.get("selectedTreeItems"));if(this.isPseudoContextualRoot({contentLink:_11})&&this.treeStoreModel&&typeof this.treeStoreModel.refreshRoots==="function"){this.treeStoreModel.refreshRoots(this);}}.bind(this)));},_getTypesToCreate:function(){return [];},_setupCommands:function(){this.inherited(arguments);var _12={selection:this.selection};var _13=new _d(_3.mixin({iconClass:"epi-iconPlus",label:_10.command.label,resources:_10,viewModel:this},_12));var _14={uploadDefault:{command:_13},upload:{command:new _f(_3.mixin({category:"context",iconClass:"epi-iconUpload",label:_10.linktocreateitem,viewModel:this},_12)),order:2},download:{command:new _e(_3.mixin({category:"context",label:_10.command.download},_12)),order:4}};this.own(_13.watch("canExecute",this._onUploadCommandUpdated.bind(this)));this._commandRegistry=_3.mixin(this._commandRegistry,_14);this.pseudoContextualCommands.push(this._commandRegistry.uploadDefault.command);this.pseudoContextualCommands.push(this._commandRegistry.upload.command);},_onUploadCommandUpdated:function(_15,_16,_17){var _18=this._commandRegistry.uploadDefault.command;var _19=_18.get("model");var _1a=_19?_19.length===1:false;var _1b=_1a?_19[0].name:null;var _1c=this.get("isSearching");var _1d={dropFolderName:_1b,validSelection:_1a,enabled:!_1c&&(_17||!_1a)};this.set("dropZoneSettings",_1d);},_selectedTreeItemsSetter:function(_1e){this._commandRegistry.uploadDefault.command.set("model",_1e);this.inherited(arguments);},upload:function(_1f,_20,_21){var _22=new _c({model:new _b({store:this.get("store"),query:this.get("listQuery")})});_22.on("beforeUploaderChange",_3.hitch(this,function(){this._uploading=true;}));_22.on("close",_3.hitch(this,function(_23){this._dialog&&(_23?this._dialog.hide():this._dialog.destroy());}));_22.on("uploadComplete",_3.hitch(this,function(_24){if(_22.createAsLocalAsset){_5(this.treeStoreModel&&typeof this.treeStoreModel.refreshRoots==="function"&&this.treeStoreModel.refreshRoots(this),_3.hitch(this,function(){_22.set("createAsLocalAsset",false);_22.set("uploadDirectory",this.get("selectedTreeItems")[0].id);_22.model.set("query",this.get("listQuery"));_6.publish("/epi/cms/action/createlocalasset",this.treeStoreModel);}));}else{this.onListItemUpdated(_24);_6.publish("/epi/cms/upload",_20);this.selectListItemsByContentReferences(_24.map(function(_25){var _26=_9.toContentReference(_25.contentLink);return _26.createVersionUnspecificReference().toString();}));}if(this._dialog&&!this._dialog.open){this._dialog.destroy();}this._uploading=false;}));this._dialog=new _8({title:_10.linktocreateitem,dialogClass:"epi-dialog-upload",content:_22,autofocus:true,defaultActionsVisible:false,closeIconVisible:false,destroyOnHide:false});this._dialog.definitionConsumer.add({name:"close",label:_7.resources.action.close,action:function(){_22.close();}});this._dialog.resize({w:700});this._dialog.show();var _27=this.get("selectedTreeItems")[0];this._buildBreadcrumb(_27,_22);_22.set("uploadDirectory",_20||_27.id);_22.set("createAsLocalAsset",_21);_22.upload(_1f);},onListItemUpdated:function(_28){var _29=this.store;return _5(this.getCurrentContext(),function(_2a){var _2b=(new _9(_2a.id)).createVersionUnspecificReference().toString();return _5(_29.get(_2b),function(_2c){var _2d=_1.filter(_28,function(_2e){return _2c.name.toLowerCase()===_2e.fileName.toLowerCase();})[0];return _2d?_2c:null;});});},_buildBreadcrumb:function(_2f,_30){if(!_30){return;}if(this.treeStoreModel.isTypeOfRoot(_2f)){_30.set("breadcrumb",[_2f]);return;}this.treeStoreModel.getAncestors(_2f.contentLink,_3.hitch(this,function(_31){var _32,_33=[_2f];for(var i=_31.length-1;i>=0;i--){_32=_31[i];_33.unshift(_32);if(this.treeStoreModel.isTypeOfRoot(_32)){break;}}_30.set("breadcrumb",_33);}));}});});