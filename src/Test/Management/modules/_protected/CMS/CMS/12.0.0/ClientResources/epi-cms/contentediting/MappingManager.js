//>>built
define("epi-cms/contentediting/MappingManager",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/connect","dojo/dom-attr","dojox/encoding/digests/SHA1"],function(_1,_2,_3,_4,_5,_6,_7){return _1(null,{_mappings:null,domUtils:null,attrNames:["data-epi-edit","data-epi-property-name","data-epi-property-display-names","data-epi-property-customsettings-customtag","data-epi-use-mvc","data-epi-disabled","data-epi-useoverlay","data-epi-overlay-z-index","data-epi-property-type","data-epi-property-edittype","data-epi-property-editorsetting","data-epi-property-editor","data-epi-property-render"],constructor:function(){this._mappings=[];this.domUtils=_6;},clear:function(){var _8;try{while((_8=this._mappings.pop())){this._clearMapping(_8);}}catch(ex){console.error(ex);}},clearMappings:function(_9){_9.forEach(function(_a){try{this._clearMapping(_a);this._mappings.splice(this._mappings.indexOf(_a),1);}catch(ex){console.error(ex);}},this);},_calculateNodeHash:function(_b){if(!_b){return "";}var _c=_3.map(this.attrNames,_2.hitch(this,function(n){return this.domUtils.get(_b,n)||"";}));return _7(_4.toJson(_c));},add:function(_d){if(_d.node){_d.nodeHash=this._calculateNodeHash(_d.node);}if(_d.blockPropertyInfo&&!_d.propertyName){_d.propertyName=_d.blockPropertyInfo.name;}this._mappings.push(_d);},_tryRemapNode:function(_e,_f){if(this._calculateNodeHash(_f.node)===_e.nodeHash){_e.node=_f.node;_e.updateController.displayNode=_f.node;_e.updateController.checkEmptyHtml();if(_e.overlayItem){_e.overlayItem.set("disabled",false);_e.overlayItem.set("sourceItemNode",_f.node);_e.overlayItem.refresh();}return {success:true,mappedNode:_f};}return {success:false};},remap:function(_10){var _11=[];var _12=(_10!=null?_10.slice(0):[]);_3.forEach(this._mappings,_2.hitch(this,function(_13){if(!_13.updateController){return;}var _14=null;var _15=_3.some(_12,_2.hitch(this,function(_16){var _17=this._tryRemapNode(_13,_16);_14=_14||_17.mappedNode;return _17.success;}));if(_15){if(_14){_12.splice(_3.indexOf(_12,_14),1);}}else{this._clearMapping(_13);delete _13.node;_11.push(_13);}if(_13.wrapper&&_13.node){_13.wrapper.set("blockDisplayNode",_13.node);}}));var _18;while((_18=_11.pop())){this._mappings.splice(_3.indexOf(this._mappings,_18),1);}return _12;},findOne:function(_19,_1a){var _1b;_3.some(this._mappings,function(m){if(m[_19]===_1a){_1b=m;return true;}});return _1b;},find:function(){var _1c;if(arguments[0]===undefined){return this._mappings;}else{if(_2.isFunction(arguments[0])){_1c=arguments[0];}else{var _1d=arguments[0],_1e=arguments[1];_1c=function(m){return m[_1d]===_1e;};}}return _3.filter(this._mappings,_1c);},_clearMapping:function(_1f){for(var _20 in _1f){if(_1f[_20]){if(_20!=="node"){if(_2.isFunction(_1f[_20].destroyRecursive)){_1f[_20].destroyRecursive();}else{if(_2.isFunction(_1f[_20].destroy)){_1f[_20].destroy();}else{if(_2.isFunction(_1f[_20].remove)){_1f[_20].remove();}}}}_1f[_20]=null;}}}});});