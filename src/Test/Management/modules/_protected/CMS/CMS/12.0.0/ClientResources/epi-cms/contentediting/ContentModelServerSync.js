//>>built
define("epi-cms/contentediting/ContentModelServerSync",["dojo/_base/array","dojo/_base/declare","dojo/Deferred","dojo/when","dojo/_base/json","dojo/Stateful","epi/assign","epi/datetime","epi/string","epi/shell/postMessage","./ContentActionSupport"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b){return _2([_6],{_queue:null,_isSynchronizing:false,hasPendingChanges:false,contentLink:null,_oldContentLink:null,contentDataStore:null,processInterval:200,_processIntervalId:0,_saveDeferred:null,_postMessage:null,constructor:function(_c){_2.safeMixin(this,_c);this._queue=[];this._postMessage=this._postMessage||_a;},_contentLinkSetter:function(_d){this._oldContentLink=this.contentLink;this.contentLink=_d;},scheduleForSync:function(_e,_f){if(_f===undefined){return;}this.set("hasPendingChanges",true);_f=_8.transformDate(_f);var _10=this._propertyIndexInQueue(_e);if(_10<0){this._queue.push({name:_e,value:_f});}else{this._queue[_10].value=_f;}},saveProperty:function(_11,_12,_13){this.scheduleForSync(_11,_12);return this._startSynchronizeInterval({delay:0,action:_13});},_propertyIndexInQueue:function(_14){var _15=-1;_1.some(this._queue,function(_16,i){if(_16.name===_14){_15=i;return true;}});return _15;},save:function(){return this._startSynchronizeInterval();},_startSynchronizeInterval:function(_17){var _18;if(!this._saveDeferred){this._saveDeferred=new _3();_18=_17&&_17.delay||this.processInterval;setTimeout(this._synchronizeItem.bind(this,_17),_18);}return this._saveDeferred.promise;},_synchronizeItem:function(_19){var _1a=this._queue,_1b=this.contentLink,_1c=this._saveDeferred;this._queue=[];this._saveDeferred=null;this.set("hasPendingChanges",false);var _1d=function(_1e){var _1f={},_20;if(_1e){_1.forEach(_1e.properties,function(_21){_21.name=_9.pascalToCamel(_21.name);},this);_20=_1e.savedContentLink;_1f=_7({successful:false,contentLink:_1e.savedContentLink,hasContentLinkChanged:this._hasContentLinkChanged(_1e)},_1e);if(_20&&_20!==this.contentLink){this.set("contentLink",_20);}_1f.oldContentLink=this._oldContentLink;this._oldContentLink=null;this._publishContentSavedMessage(_1f);_1c.resolve(_1f);}else{_1c.reject({contentLink:_1b,properties:_1a,error:"Unexpected result returned from the server."});}}.bind(this);var _22=function(_23){var _24={contentLink:_1b,properties:_1a,error:_23};_1c.reject(_24);}.bind(this);if(_1a.length===0){_1c.resolve();return;}_4(this._saveProperties(_1a,_19)).then(_1d).otherwise(_22);},_hasContentLinkChanged:function(_25){var _26=this._oldContentLink&&this._oldContentLink!==this.contentLink;return _25.savedContentLink&&_25.savedContentLink!==this.contentLink||_26;},_publishContentSavedMessage:function(_27){this._postMessage.publish("contentSaved",{contentLink:_27.contentLink});this._postMessage.publish("beta/contentSaved",_27);},pendingSync:function(_28){return this._propertyIndexInQueue(_28)!==-1;},_saveProperties:function(_29,_2a){var _2b=this.contentLink,_2c={};_1.forEach(_29,function(_2d){_2c[_2d.name]=_5.toJson(_2d.value);});var _2e={id:_2b,properties:_2c,action:_2a?_2a.action:_b.saveAction.Save|_b.saveAction.SkipValidation};return this.contentDataStore.patch(_2e,{id:_2e.id});}});});