//>>built
define("epi-cms/contentediting/ContentViewModel",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/json","dojo/Deferred","dojo/_base/lang","dojo/topic","dojo/on","dojo/when","dojo/promise/all","dojo/Stateful","dijit/Destroyable","dgrid/List","dgrid/extensions/DijitRegistry","epi","epi/dependency","epi/shell/UndoManager","epi/shell/DialogService","epi/shell/conversion/ObjectConverterRegistry","epi/shell/widget/dialog/Alert","epi/shell/Stateful","epi/shell/xhr/errorHandler","../ApplicationSettings","./ContentActionSupport","./ContentEditingValidator","./ContentModelServerSync","./Operation","epi/i18n!epi/cms/nls/episerver.cms.contentediting","epi/i18n!epi/cms/nls/episerver.cms.components.versions"],function(_1,_2,_3,_4,_5,_6,_7,on,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,res,_1b){return _3([_a,_b],{contentModel:null,metadata:null,syncService:null,editorFactory:null,validator:null,contentDataStore:null,profileHandler:null,languageContext:null,enableAutoSave:true,_converterRegistry:null,_contentVersionStore:null,_syncRetryTimeout:60000,undoManager:null,contextTypeName:"",contentLink:null,contentData:null,viewName:null,isCreatingNewVersion:false,hasUndoSteps:false,hasRedoSteps:false,isValid:true,hasPendingChanges:false,lastSaved:null,isSaved:true,isSaving:false,isOnline:true,hasErrors:false,validationErrors:null,isChangingContentStatus:false,isSuspended:false,constructor:function(){this.contentModel=new _14();},postscript:function(){this.inherited(arguments);this.profileHandler=this.profileHandler||_f.resolve("epi.shell.Profile");this.metadataManager=this.metadataManager||_f.resolve("epi.shell.MetadataManager");this.projectService=this.projectService||_f.resolve("epi.cms.ProjectService");this.currentContentLanguage=this.currentContentLanguage||_16.currentContentLanguage;this.contentDataStore=this.contentDataStore||_f.resolve("epi.storeregistry").get("epi.cms.contentdata");if(!this._contentVersionStore){this._contentVersionStore=_f.resolve("epi.storeregistry").get("epi.cms.contentversion");}this.undoManager=this.undoManager||new _10();this.validator=this.validator||new _18({contextId:this.get("contentLink"),contextTypeName:this.contextTypeName});this._dialogService=this._dialogService||_11;if(!this.syncService){this._createSyncService();}var _1c=_6.hitch(this,function(_1d,_1e,_1f){this.set(_1d,_1f);});this._operation=new _1a();this.own(this.syncService.watch("hasPendingChanges",_1c),this.validator.watch("isValid",_1c),this.validator.watch("hasErrors",_1c),this.undoManager.watch("hasUndoSteps",_1c),this.undoManager.watch("hasRedoSteps",_1c),on(this._operation,"commit",_6.hitch(this,this._commitChanges)));},setActiveProperty:function(_20){this.onSetActiveProperty(_20);},suspend:function(){this.set("isSuspended",true);this.onContentChange();this.onSuspend();},onSuspend:function(){},wakeUp:function(){this.set("isSuspended",false);},destroy:function(){this.clear();this.inherited(arguments);},clear:function(){this.undoManager.clear();},_createSyncService:function(){var _21=new _19({contentLink:this.get("contentLink"),contentDataStore:this.contentDataStore});this.syncService=_21;},connectLocal:function(_22,obj,evt,_23){if(!_6.isArray(_22)){throw Error("First argument to connectLocal must be an Array");}return _22.push(_2.connect(obj,evt,this,_23));},disconnectLocal:function(_24){if(_6.isArray(_24)){var _25;while((_25=_24.pop())){_2.disconnect(_25);}}},resetNotifications:function(){this.validator.clearErrorsBySource(this.validator.validationSource.client);},beginOperation:function(){this._operation.begin();},endOperation:function(){this._operation.end();},abortOperation:function(){this._operation.abort();},getProperty:function(_26){return this.contentModel.get(_26);},setProperty:function(_27,_28,_29){this._setModelProperty(_27,_28,_29);},scheduleForPublish:function(_2a){return this.saveProperty("iversionable_startpublish",_2a,_17.saveAction.ForceCurrentVersion|_17.saveAction.Schedule);},saveProperty:function(_2b,_2c,_2d){return this.syncService.saveProperty(_2b,_2c,_2d).then(function(_2e){this.set("validationErrors",_2e.validationErrors);this.contentModel.set(_2b,_2c);return this.changeContentStatus(_2d,true);}.bind(this));},saveAndPublishProperty:function(_2f,_30,_31){return _8(this.syncService.saveProperty(_2f,_30,_17.saveAction.Publish|_31),_6.hitch(this,function(_32){this.validator.setGlobalErrors(_32.validationErrors,this.validator.validationSource.server);this.contentModel.set(_2f,_30);return _8(_9([this.contentDataStore.refresh(_32.contentLink),_32.publishedContentLink?this.contentDataStore.refresh(_32.publishedContentLink):null]),_6.hitch(this,function(_33){var _34=_33[0];this.set("contentData",_34);return _32;}));}));},_commitChanges:function(_35){var _36=[];_35.forEach(function(_37){_36.push({propertyName:_37.propertyName,value:_37.oldValue,oldValue:_37.value});},this);this.undoManager.createStep(this,this._saveProperties,[_36],"Edit properties");},_saveProperties:function(_38){this.beginOperation();_1.forEach(_38,function(p){this._setModelProperty(p.propertyName,p.value,p.oldValue);},this);this.endOperation();},_setModelProperty:function(_39,_3a,_3b){_3b=_3b===undefined?this.contentModel.get(_39):_3b;this.set("isSaved",false);this.contentModel.set(_39,_3a);this._operation.save({propertyName:_39,value:_3a,oldValue:_3b});this.syncService.scheduleForSync(_39,_3a);this.enableAutoSave&&this.save();this.onPropertyEdited(_39,_3a);},onPropertyEdited:function(_3c,_3d){},onPropertySaved:function(_3e,_3f){},onPropertyReverted:function(_40,_41){this.contentModel.set(_40,_41);},_onSynchronizeSuccess:function(_42,_43,_44){_1.forEach(_43,_6.hitch(this,function(_45){this.validator.clearPropertyErrors(_45.name,this.validator.validationSource.server);this._patchContentDataStore(_42,_45.name,null,_45.value);this.onPropertySaved(_45.name,_45.value);}));this.validator.setGlobalErrors(_44.validationErrors,this.validator.validationSource.server);},_onSynchronizeFailure:function(_46,_47,_48,_49){var _4a=[];_1.forEach(_47,function(_4b){if("successful" in _4b){if(_4b.successful){this.validator.clearPropertyErrors(_4b.name,this.validator.validationSource.server);}else{_4a.push(_4b);}}},this);if(_4a.length){var _4c=_1.map(_4a,function(_4d){return _4d.validationErrors;});this._showErrorsDialog(res.autosave.error,_4c,_6.hitch(this,function(){_1.forEach(_4a,function(_4e){this.onPropertyReverted(_4e.name,_4e.value);},this);}));}if(_49){if(_49.validationErrors){this.validator.setGlobalErrors(_49.validationErrors,this.validator.validationSource.server);}else{this.validator.clearGlobalErrors(this.validator.validationSource.server);}}},_showErrorsDialog:function(_4f,_50,_51){var _52=new (_3([_c,_d]))({className:"epi-grid-max-height--300"});_52.renderArray(_50);_52.startup();function _53(){if(typeof _51==="function"){_51();}this._currentErrorDialog=null;};if(this._currentErrorDialog){this._currentErrorDialog.set("content",_52);}else{this._currentErrorDialog=new _13({description:_4f,content:_52,onAction:_53.bind(this)});this._currentErrorDialog.show();}},_contentLinkChanged:function(_54){this.set("contentLink",_54);this.syncService.set("contentLink",_54);this.validator.setContextId(_54);this.onContentLinkChange();},ensureWritableVersion:function(){var _55=this.get("contentLink");if(!this.contentData.isNewVersionRequired){return _55;}if(this._isCreatingNewVersionDeferred&&!this._isCreatingNewVersionDeferred.isFulfilled()){return this._isCreatingNewVersionDeferred.promise;}else{this._isCreatingNewVersionDeferred=new _5();}this.isCreatingNewVersion=true;_8(this._contentVersionStore.put({originalContentLink:_55}),_6.hitch(this,function(_56){this.contentDataStore.refresh(_56.contentLink).then(_6.hitch(this,function(_57){this.set("contentData",_57);})).always(_6.hitch(this,function(){this.isCreatingNewVersion=false;this._contentLinkChanged(_56.contentLink);this._isCreatingNewVersionDeferred.resolve(_56);}));}),_6.hitch(this,function(_58){this.isCreatingNewVersion=false;this._isCreatingNewVersionDeferred.reject(_58);var _59=_58.responseText?_4.fromJson(_58.responseText):_58.message;this.validator.setGlobalErrors(_59,this.validator.validationSource.server);}));return this._isCreatingNewVersionDeferred.promise;},validate:function(){var def;if(!this.validator){def=new _5();def.resolve();}else{def=this.validator.validate();}return def;},revertToPublished:function(){var _5a=this.get("contentLink");return _8(this._contentVersionStore.remove(_5a),function(){this._loadPublishedVersion(_5a);}.bind(this),function(_5b){var _5c;if(_5b.status===403){_5c=_1b.deleteversion.cannotdeletepublished;}else{if(_5b.status===404){_5c=res.versionstatus.versionnotfound;}}if(_5c){return this._dialogService.alert(_5c).then(function(){this._loadPublishedVersion(_5a);}.bind(this));}}.bind(this));},_loadPublishedVersion:function(_5d){_8(this._contentVersionStore.query({contentLink:_5d,language:this.languageContext?this.languageContext.language:"",query:"getpublishedversion"}),_6.hitch(this,function(_5e){if(_5e!==null){var _5f={uri:"epi.cms.contentdata:///"+_5e.contentLink,context:this};_7.publish("/epi/shell/context/request",_5f,{sender:this,forceReload:true});}}));},createDraft:function(){var _60=this.get("contentLink"),_61=this.contentData.isCommonDraft&&this.contentData.status===_17.versionStatus.DelayedPublish&&!this.projectService.isProjectModeEnabled;return _8(this._contentVersionStore.put({originalContentLink:_60,isCommonDraft:_61}),_6.hitch(this,function(_62){var _63={uri:"epi.cms.contentdata:///"+_62.contentLink,context:this};_7.publish("/epi/shell/context/request",_63,{sender:this});_7.publish("/epi/cms/content/statuschange/","common-draft",{id:_62.contentLink});}));},editCommonDraft:function(){var _64=this.get("contentLink");return _8(this._contentVersionStore.query({contentLink:_64,query:"getcommondraftversion"}),_6.hitch(this,function(_65){var _66={uri:"epi.cms.contentdata:///"+_65.contentLink,context:this};_7.publish("/epi/shell/context/request",_66,{sender:this});}));},_populateContentModel:function(_67,_68){var _69={},_6a,_6b;for(var _6c in _67){var _6d=_68.getPropertyMetadata(_6c);var _6e=_67[_6c];if(_6d.hasSubProperties()){_69[_6c]=this._populateContentModel(_6e,_6d);}else{_69[_6c]=_6e;_6a=_6d.customEditorSettings.converter;if(_6a){_6b=_12.getConverter(_6a,"runtimeType");if(_6b){_69[_6c]=_6b.convert(_6a,"runtimeType",_6e);}}}}return _69;},getPropertyMetaData:function(_6f){return _8(this._getMetadata(),function(_70){return _70.getPropertyMetadata(_6f);});},reload:function(){return _8(_9([this.contentDataStore.get(this.get("contentLink")),this._getMetadata(true)]),_6.hitch(this,function(_71){var _72=_71[0],_73=_71[1];this.set("contentData",_72);var _74=this.get("contentModel");var _75=this._populateContentModel(_72.properties,_73);for(var _76 in _75){if(_75.hasOwnProperty(_76)&&!_e.areEqual(_74.get(_76),_75[_76])){_74.set(_76,_75[_76]);}}}));},_getMetadata:function(_77){var _78=this.get("metadata");if(!_77&&_78){return _78;}var _79=this;return _8(this.metadataManager.getMetadataForType("EPiServer.Core.ContentData",{contentLink:this.get("contentLink")}),function(_7a){_79.set("metadata",_7a);return _7a;});},save:function(){if(!this.isOnline){var def=new _5();def.resolve(true);return def;}return this._save();},_save:function(){var def=new _5(),_7b=_6.hitch(this,function(_7c){if(_7c){if(_7c.successful){this._onSynchronizeSuccess(_7c.contentLink,_7c.properties,_7c);}else{this._rescheduleProperties(_7c.properties);this._onSynchronizeFailure(_7c.contentLink,_7c.properties,_7c.validationErrors,_7c);}if(_7c&&_7c.hasContentLinkChanged&&this.contentLink!==_7c.contentLink){this._contentLinkChanged(_7c.contentLink);}this.set("validationErrors",_7c.validationErrors);}this.set("isOnline",true);this.set("lastSaved",new Date());this.set("isSaving",false);this.set("isSaved",true);def.resolve(true);}),_7d=_6.hitch(this,function(_7e){this.set("hasErrors",true);this.set("isSaving",false);this.set("isSaved",false);if(_7e&&_7e.error&&(_7e.error.status===409||_7e.error.status===404)){var _7f=_7e.error.status===409?res.autosave.conflict:res.autosave.reloadmessage;this._showErrorsDialog(_7f,[]);}else{this.set("isOnline",false);if(_7e){this.set("validationErrors",_7e.validationErrors);this._rescheduleProperties(_7e.properties);}setTimeout(_6.hitch(this,function(){this.set("isOnline",true);this._save();}),this._syncRetryTimeout);}def.reject(_7e);});if(!this.hasPendingChanges){_7b();}else{_8(this.ensureWritableVersion()).then(_6.hitch(this,function(){this.set("isSaving",true);return this.syncService.save();})).then(_7b).otherwise(_7d);}return def;},_rescheduleProperties:function(_80){_1.forEach(_80,_6.hitch(this,function(_81){if(!this.syncService.pendingSync(_81.name)){this.syncService.scheduleForSync(_81.name,_81.value);}}));},undo:function(){!this.get("isSuspended")&&this.undoManager.undo();},redo:function(){!this.get("isSuspended")&&this.undoManager.redo();},_patchContentDataStore:function(_82,_83,_84,_85){var _86={};_6.setObject(_83,_85,_86);return this.contentDataStore.patchCache({contentLink:_82,changedBy:this.profileHandler.userName,saved:(new Date()).toISOString(),properties:_86});},changeContentStatus:function(_87,_88){var _89=this.get("contentLink");var def=new _5();this.set("isChangingContentStatus",true);var _8a=_6.hitch(this,function(_8b){var _8c=_8b&&_8b.success;var _8d=this.validator;if(_8c){if(_87===_17.saveAction.Publish||_87===_17.saveAction.CheckIn||_87===(_17.saveAction.CheckIn|_17.saveAction.DelayedPublish|_17.saveAction.ForceCurrentVersion)){this.set("lastSaved",null);}if(_8d){_8d.clearGlobalErrors(_8d.validationSource.server);}var _8e={id:_8b.id,oldId:_89};_7.publish("/epi/cms/content/statuschange/",_87,_8e);def.resolve(_8e);}else{if(_8b&&_8b.validationErrors){if(_8d){_8d.setGlobalErrors(_8b.validationErrors,_8d.validationSource.server);_8d.validate();}def.reject(null);}else{def.reject((_8b&&_8b.errorMessage)?_8b.errorMessage:res.publish.error);}}this.set("isChangingContentStatus",false);});var _8f=_6.hitch(this,function(_90){_7.publish("/epi/cms/action/showerror");def.reject((_90&&_90.errorMessage)?_90.errorMessage:res.publish.error);this.set("isChangingContentStatus",false);});this.onContentChange();if(_88){var _91;if(this.validationErrors&&this.validationErrors.length>0){_91=!this.validationErrors.some(function(_92){return _92.severity===3;});}else{_91=true;}_8a({id:this.contentLink,success:_91,validationErrors:this.validationErrors});}else{_8(this.validate()).then(this.save.bind(this)).then(function(){return _15.wrapXhr(this.contentDataStore.executeMethod("ChangeStatus",this.get("contentLink"),{action:_87}));}.bind(this)).then(_8a).otherwise(_8f);}return def;},_lastSavedGetter:function(){if(this.lastSaved){return this.lastSaved;}if(this.contentData){return this.contentData.saved;}return null;},onContentChange:function(){},onContentLinkChange:function(){if(this.get("isSuspended")){return;}var _93={uri:"epi.cms.contentdata:///"+this.get("contentLink")};_7.publish("/epi/shell/context/request",_93,{sender:this,contextIdSyncChange:true,trigger:"internal"});},hasEditAccess:function(){return _17.hasAccess(this.contentData.accessMask,_17.accessLevel.Edit);},hasAccess:function(_94){var _95=!this.languageContext||!this.languageContext.isTranslationNeeded;return _95&&_17.isActionAvailable(this.contentData,_94||_17.action.Edit,_17.providerCapabilities.Edit);},canTranslateContent:function(){if(this.viewLanguage&&this.languageContext&&this.viewLanguage!==this.currentContentLanguage){return false;}return true;},canChangeContent:function(_96){var _97=this.projectService.isProjectModeEnabled&&this.contentData.isPartOfAnotherProject;return !_97&&this.canEditCurrentLanguage()&&this.hasAccess(_96);},canEditCurrentLanguage:function(){if(!this.languageContext){return true;}return this.languageContext.language===this.currentContentLanguage;},_contentDataSetter:function(_98){this.contentData=_98;if(_98.contentLink!==undefined){this.set("contentLink",_98.contentLink);}},_showOverlayGetter:function(){var _99=this.getProperty("iversionable_shortcut");if(_99&&_99.pageShortcutType){return _99.pageShortcutType!==4;}return true;}});});